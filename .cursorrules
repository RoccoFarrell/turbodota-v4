# Cursor Rules for TurboDota v4

## Documentation Organization

If you create any markdown files for planning or tracking, place them in the `docs` folder, and under a subfolder related to which part of the codebase it's related to.

Example structure:
- `docs/upgrades/` - for upgrade and migration plans
- `docs/api/` - for API documentation
- `docs/architecture/` - for architecture documentation
- etc.

## Prisma / Database migrations

**ANY TIME** we change the database (add/remove/alter models, fields, enums, or indexes in `prisma/schema.prisma`):

1. **Create a migration** â€“ Do not only edit `schema.prisma`. Create a proper migration so history stays in sync:
   - Run: `npx prisma migrate dev --name <descriptive_name>` (e.g. `add_user_preferences`, `phase7_run_rewards`).
   - This creates a new folder under `prisma/migrations/<timestamp>_<name>/` with `migration.sql` and records it in the migration history.
2. **Do not** use only `prisma db push` for schema changes that should be tracked (push does not create migration files and can desync history).
3. **Do not** manually edit or delete existing migration files that have already been applied; that will desync production.
4. If the user is baselining or resetting migration history, follow the steps in `prisma/BASELINE_INSTRUCTIONS.md` and do not run migrations that would drop or reset the production database without explicit user confirmation.

This keeps migration history in sync and avoids "relation does not exist" or "migration failed" when deploying.

## Migration Tools Directive

**CRITICAL**: If a migration tool needs to be run and fails (e.g., requires interactive terminal, TTY errors, etc.), DO NOT attempt to apply changes manually. Instead, stop and prompt the user to run the migration tool manually. This directive applies to all migration tools including but not limited to:
- `npx sv migrate` (Svelte migration)
- `npx svelte-migrate` (SvelteKit migration)
- `npx skeleton migrate` (Skeleton migration)
- Tailwind CSS migration tools
- Any other automated migration scripts

## Card Battler Development Rules

When working on the card battler feature (following `docs/card-battler/DEVELOPMENT_ROADMAP.md`):

### Library Usage
- **ALWAYS** prefer existing libraries in `package.json` over installing new ones
- Check available libraries before adding dependencies:
  - SvelteKit features for backend (`@sveltejs/kit`)
  - Skeleton UI components (`@skeletonlabs/skeleton`, `@skeletonlabs/skeleton-svelte`)
  - Tailwind CSS utilities (`tailwindcss`, `tailwind-merge`, `tailwind-variants`)
  - Prisma for database (`@prisma/client`, `prisma`)
  - Vitest for testing (`vitest`, `@vitest/ui`)
  - Bits UI components (`bits-ui`)
  - Other existing dependencies as appropriate

### Progress Tracking
- **MUST** maintain `docs/card-battler/PROGRESS.md` documenting:
  - Completed milestones with checkboxes
  - Test results for each milestone
  - Any blockers or issues encountered
  - Date completed and verification status
- Update progress immediately after completing and testing each milestone

### Documentation Updates
- **ALWAYS** update relevant markdown docs in `docs/card-battler/` after code changes:
  - `DEVELOPMENT_ROADMAP.md` - Mark completed milestones
  - `PROGRESS.md` - Document completion status
  - `README.md` - Update if architecture changes
  - `BATTLE_MECHANICS.md` - Update if mechanics change
  - `HERO_SPECIFICS.md` - Update if hero data changes
  - Other relevant docs as needed

### Backend Development
- Use **SvelteKit** for all backend functionality:
  - API routes: `src/routes/api/battler/**/+server.ts`
  - Server load functions: `+page.server.ts` or `+layout.server.ts`
  - Server hooks: `src/hooks.server.ts`
  - Form actions: Use SvelteKit form actions
  - Database access: Use Prisma client in server-side code only
  - Reference: https://kit.svelte.dev/docs

### Frontend Development
- Use **Tailwind CSS** for styling:
  - Utility-first approach
  - Use existing Tailwind config and variants
  - Leverage `tailwind-merge` for conditional classes
- Use **Skeleton UI** components and features:
  - Prefer Skeleton components over custom implementations
  - Use Skeleton theme system for colors and styling
  - Reference: https://www.skeleton.dev/docs/svelte/get-started/introduction
  - Available components: Buttons, Cards, Forms, Dialogs, Menus, etc.

### Development Workflow
1. Review milestone dependencies in `DEVELOPMENT_ROADMAP.md`
2. Implement milestone following the roadmap structure
3. Write tests as specified in the milestone
4. Run tests and verify functionality
5. Update `PROGRESS.md` with completion status
6. Update relevant documentation files
7. Mark milestone as complete in `DEVELOPMENT_ROADMAP.md`
